---
author: Hugo Authors
title: 网络基础应用知识
date: 2023-12-03
description:  网络基础知识
series: 
  - 网络安全基础

---

OSPF详解

<!--more-->

### OSPF路由
#### OSPF：开放式最短路径优先。协议号：89
  - 开放式：公有协议，所有厂商都支持
  - 最短路径优先：以最短路径，最快方式转发数据包
  - 作用：动态感知全网状态，自动计算路由
  - 应用：通常用于企业内部，和数据中心内部
  - 工作在OSI模型中的第三层，数据封装在IP头部后面
  - OSPF是基于链路状态的内部网关协议
#### 优势：
  - 利用`累计cost值`来计算最优路径
  - 采用组播形式收发协议报文，提高效率
  - 用区域的概念，降低设备压力，更加利于管理
  - 支持等价路由负载分担，提高可靠性
  - 支持报文认证，提高安全性
#### 基础概念
  - 在同一区域内的所有ospf路由器，数据库是完全一样的
  - Router ID
    唯一，在OSPF网络中标识一台路由器的唯一标识
    - 特点：稳定，一旦确定，就不会改变，要更改只能重启OSPF进程
    - OSPF协议为路由设备起的名字
    - Router ID可以手动指定，也可以自动选举
    - 如果没有手动配置，则路由器使用Loopback接口中最大的IP地址作为Router ID
    - 如果没配置接口，则路由器使用物理接口中最大的IP地址作为Router ID
  - area ID
    将路由设备划分成不同的组，每个组用区域号标识
    - 区域号
      
      用于标识一个网络区域，通过这样来缩减路由规模，降低路由设备分担。
      - 骨干区域：0
      - 非骨干区域：不为0
      - 区域号表示：
        - 十进制
        - 点分十进制
  - cost：开销
    
    OSPF路径会累积cost值来计算最短路径
    - 每一个开启OSPF功能的物理接口都有一个cost值为1

  - DR和BDR、DRother

    这是一个接口的概念，不是路由器的概念，他是建立邻居的时候才会选举的
    - DR（指定路由器）BDR（备份指定路由器）DRother（其他路由器）
    - DRother之间建立to-way（邻居）关系，但他和DR/BDR建立Full（邻接）关系
    - 作用：减少邻接关系，加快数据库同步
    - 选举规则：
      - 选举是非抢占式的
      - 选举是基于接口的
    - 优先级越高越优先，当优先级为0是则这个接口一定是DRother

#### OSPF路由器类型
- 区域内路由器————路由器的所有接口都属于同一个OSPF区域
- 骨干区域路由器————路由器只要有一个接口属于骨干区域
- ABR（区域边界路由器）————同时连接着骨干和非骨干区域的路由器
- ASBR（自治系统边界路由器）————与其他AS交换路由信息的路由器成为ASBR，具有产生外部路由能力的路由器。
#### 工作原理
  - 建立OSPF邻居表--hello
    - hello报文源IP：路由器物理接口IP
    - hello报文目的IP：224.0.0.5，组播IP
    - hello报文周期性发送，在广播型网络和P2P网络中，默认是10秒发送一次
    - hello报文作用：发现，建立，维护，断开
    - 邻居状态：two-way
    - 如果是广播型网络，在建立好邻居后，选举DR（指定路由器）和BDR（备份指定路由器）
    - 所有DR-other都与DR/BDR建立邻接关系：full：需要同步数据库
    - DR-other和DR-other只建立邻居关系：two-way：不需要同步数据库
    - 选举DR的作用：减少邻接关系，加快数据库同步
    - 建立邻居的本质是：是邻居建立后，可以同步数据库
  - 同步OSPF数据库--利用DD、LSR、LSU、LSACK
    - DD报文：数据库描述报文
      - 第一个DD报文用来选举主从关系
        - 选举主从关系的目的：保证数据库同步的youxvxing，可靠性
      - 第二DD报文：携带数据库摘要信息：LSA头部信息
        - 收到后续的DD报文后，就可以了解邻居数据库有哪些LSA
      - 如果发现邻居的数据库中有我没有的LSA就可以通过LSR请求对方数据库中的LSA
      - 收到邻居发来的LSU报文后，hi夫LSACK确认报文，告诉邻居，我收到了
      - 当邻居之间数据库中的LSA完全相同时，数据库同步结束
    - 数据库同步：其实本质上只是在做一件事，在互相传输LSA
      - LSA：
        - 链路状态通告：计算路由的原材料（拓扑信息+网段信息）
        - 拓扑信息：我的邻居是谁，我用哪个接口连接着我的邻居
        - 网段信息：我的接口IP地址段，接口掩码，接口cost值

      那么邻居之间相互传输LSA的目的又是什么呢？
        - 计算路由条目

  - 计算OSPF路由表
#### 五种报文 七大状态
  - Hello 报文：用于发现、建立、维护和拆除OSPF邻居

    第一个Hello报文用来建立邻居，后续Hello报文用于同步数据库
    - down：挂掉了，表示给hide设备之间的邻居状态最新的开始
    - init：初始化状态，收到对端的Hello报文，进入Init状态，但此时的Hello报文不包含自己的Router ID
    - two-way：
      - 双向通信状态，收到的Hello报文中包含自己的Router ID，则状态为two-way此时两台设备之间为邻居状态
      - 在广播网络里，我们会选举DR/BDR（DR/BDR没有抢占）
    - 在这个状态下，我发送的Hello报文对端收到了
    - 对端发送的Hello报文，我也收到了
  - DD：数据库描述报文
  
    用于发送OSPF数据库数据库条目（LSA头部信息）的简要信息，实现数据库同步

    - ExStart状态
      - 交换初始化状态。在该阶段，交互第一个DD报文，为了保证后期交换状态的稳定和可靠，所以该阶段会进行邻居路由器之间主从关系的确定
    - Exchange状态
      - 交换状态，交互的是大量的DD报文，我们称之为LSA头部信息

  - LSR：链路状态请求报文

    用于请求自己数据库中没有的链路状态通告信息
    - Loading状态
      - 加载状态，两边通过了交换，完成了数据库的比较，那么就会在该阶段进行加载，会对自己没有的那些数据库条目进行请求lsr，对方设备回应更新LSU包含完整的LSA，为了确保可靠传输，在双方设备收到后，会给对方回应一个LSACK报文，双发设备都经过了上面的三个报文之后，实现数据库的完全相同，就会进入到下一个状态。
  - LSU：链路状态更新报文

    用于回应LSR报文，发送链路状态信息。
    - Loading状态：同上
  - LSACK

    确认LSU和LSR报文
    - Loading状态：同上
  - 全部完成后是full状态
    - 完全邻接状态，表示两个设备的数据库完全相同


  
#### LSA
  
  - OSPF路由怎么来的
    
    靠LSA计算出来的
    - LSA怎么来的：通过数据库同步，从邻居那里学来的。
    - 而且LSA非常重要，我们要保证传递的可靠性和有序性。
  - 如何保证：
    - 选举主从：Master/Slave，作用：保证数据库同步的有序性准确性
    - 利用router-id来选举，大的为Master
    - 选举完成后小弟永远使用大哥序列号，大哥序列号永远加1
    - 下一个报文是对上一个报文的确定（例:LSU给LSR，Lsack给LSU）

    这样传递的目的是为了，让DD报文更有序，可靠不丢失
- LSA
  - 作用：用来计算路由的
  - 如何形成的：
    - network
    - import-router：五类LSA

LSA（链路状态通告）七个字段，通常用其中3个字段来区分不同的LSA
  - 类型，名字，通告路由

##### 五类LSA
  - 一类LSA

    - 类型（Type）： Router-LSA
    - 名字（LinkState ID）：1类LSA的名字取自-生产这条LSA的路由器的Router-id
    - 通告路由器：(AdvRouter)：区域内每一台路由器都会产生一个1类LSA
    - 特点：每一个运行OSPF协议的路由器，都会在这台路由器所处的区域中生成一个1类的LSA
    - 传递范围：只能在区域内传递
    - 作用：用来计算域内路由（做自我介绍）
          自我介绍，介绍什么内容：
          介绍两个内容：拓扑信息+网段信息
          拓扑信息：我是谁，我的邻居是谁，我用那个接口IP连接着我的邻居
          网段信息：我的接口网段，我接口网段的掩码，我的接口的cost开销值
 
 - 点到点

    LSA的头部信息：
    ```
    Type ：Router ：我是一类IP
    Ls id ：1.1.1.1：我的名字是1.1.1.1
    Adv rtr ：1.1.1.1：我的老爹是1.1.1.1（通告路由其-创造这条LSA的设备）
    Ls age ：372：我的年龄是372秒
    Len ：60：我的长度为60字节
    Options ：E：我的能力：引入外部路由
    seq# ：8000001f：我的序列号：
                    LSA的寿命是3600秒
                    1800秒就刷新一次，没刷新一次序列号加1
                    这叫周期性更新，还有触发式更新
                     序列号越大，代表LSA越新
    chksum ：0x4a9：我的校验和（序列号相同的情况下，校验和越大LSA越新）
    ```  
  - LSA链路信息
    ```
      Link count: 3                    我有3条链路（LSA表示了两种信息，拓扑信息和网段信息）
      Link ID: 2.2.2.2              我是邻居的名字
      Data   : 192.168.12.1      我的接口IP地址是192.168.12.1（我用这个IP连接我的邻居）
      Link Type: P-2-P           这是描述的拓扑信息  
      Metric : 1                      我的cost值是1

      Link ID: 192.168.12.0      我的接口的IP地址段是192.168.12.0
      Data   : 255.255.255.0     我的接口的IP地址段的掩码是24
      Link Type: StubNet         这是描述的网段信息
      Metric : 1                       我的cost值是1
      Priority : Low

      Link ID: 192.168.1.0       我的接口IP地址段是192.168.1.0
      Data   : 255.255.255.0     我的接口IP地址段的掩码是24
      Link Type: StubNet         这是描述的网段信息
      Metric : 1                        我的cost值是1
      Priority : Low

    ```

  - 二类LSA
    - 类别：network-LSA
    - 名字：2类LSA的名字取自，DR的接口IP地址
    - 通告路由器：DR接口所在的那台路由器的Router-id
    - 作用：
      - 补全DR接口IP地址的掩码信息。
      - 记录和DR建立邻接关系的路由器，用于描述网段内完整拓扑信息
      - 最终作用：辅助1类LSA完成区域内路由的计算
  
  - 一类和二类LSA的作用：计算域内路由
    - 传播范围：只能在区域内传播
  
  - 三类LSA
    - 类别：Network-summary-LSA
    - 名字：3类LSA的名字取自区域间路由网段的名字
    - 通告路由器：本区中的ABR路由器的Router-id
    - 传递范围：3类的LSA仅仅在区域内传播
    - 作用：
      - 计算域间路由 
      - 将区域内的1、2LSA计算出来的路由，变成3类LSA在其他区域泛洪（广播），实现区域与区域之间的通信
    - 总结：
      - 3类LSA在传递过程中，每经过一个ABR它的名字就会发生变化。
    - 三类LSA头部信息   
    ```
      Type      : Sum-Net           我是三类LSA
      Ls id     : 192.168.45.0      我的名字是192.168.45.0
      Adv rtr   : 2.2.2.2           我是从2.2.2.2那里学来的
      Ls age    : 969 
      Len       : 28 
      Options   :  E  
      seq#      : 80000006 
      chksum    : 0xa016
      Net mask  : 255.255.255.0     下一跳的掩码
      Tos 0  metric: 3              所 用消耗
      Priority  : Low
    ```
  - 四类LSA

    就是带你去找ASBR的
    - 类别：ASBR-summary -LSA 
    - 名字：取自asbr的router-id
    - 通告路由器：本区域的ASBR设备
      - 第一个四类LSA是由和ASBR在同一个区域内的那个ABR产生的
      - 后续的4类LSA，是由本区域的ABR产生的
    - 传播范围：在一个区域内传播
    - 特点：4类LSA在传播过程中，每经过一个ABR，通过路由器就会变成所经过的那台ABR的router-id
    - 作用： 
      - 配合5类LSA计算外部路由
      - 将5类LSA传递到其他路由器中
    - 带你去找ASBR
  - 五类LSA

    带你去往外部网段，但是去找外部网段，就需要先找到ASBR
    - 类别：AS_external-LSA
    - 名字：外部路由网段的名字
    - 通告路由器：ASBR的router-id
    - 作用：计算外部路由
    - 传递范围：在整个ospf网络内传播
    - 特点：
      - 只有ASBR可用产生5类的LSA
      - 5类的LSA可用传输到ospf网络的所有的路由器（特殊区域除外）
      - 5类LSA在传输过程中，不会产生任何变化
      - 5类LSA不属于任何区域
      - 他想去哪里就去哪里
    - 查询命令：
      ```
      display ospf lsdb ase
      display ospf lsdb ase 192.168.3.0
      ```
  - 四类和五类LSA的作用：用于计算外部路由
#### OSPF特殊区域（保护这个区域不受外部路由器的影响）
  - stub区域
    - 末梢区域：网络的边缘末梢，脆弱的需要保护的区域（）
    - 保护这个区域
      - 不学习四类五类LSA
    - 该区域会产生一个默认路由的5类LSA，保证和外部的通信
  - totally stub区域
    - 完全的末梢区域
    - 不要三四五类LSA
  - nssa：不那么stub区域
    - 作用：
      - 保护一个区域不受来自外部链路的影响
      - 缩减数据库规模，缩减路由表规模，降低设备压力
      - 还能引入外部路由
    - 特点：
      - 不学习4类、5类的LSA
      - 学习1类、2类、3类和7类LSA
      - NSSA区域不学习四类和五类LSA，任何人与外部通信：
        - 利用区域内的ASR设备生产一条默认的7类LSA（0.0.0.0）用于访问外部网络
        - 这条默认的7类LSA计算出来的是一条OSPF外部路由，优先级为150，路由类型o_NSSA
      - NSSA区域的ABR还会自动地将外部7类的LSA转成5类的LSA，传播给其他区域
      - 7类的LSA只能在特殊区域nssa内部传播 
      - 备注：
        - stub区域生产的是一条默认的3类LSA，计算出来的是OSPF内部路由，优先级为10
        - O_NSSA：代表外部路由，由7类LSA计算出来的外部路由，优先级：150
        - O_ASE：也表示外部路由，由5类的LSA计算出的外部路由，优先级：150
        - OSPF表示内部路由，由3类的默认LSA计算，优先级为：10
        - nssa区域继承了stub的优点，并且还可以引入外部路由
        - 骨干区不能做成nssa区域
  - totally nssa区域
    - 作用：
      - 保护一个区域不受来自外部链路的影响，也不受区域间路由的影响
      - 缩减LSA的数量，减少路由表规模，降低设备负载
      - 还能引入外部路由
    - 特点：
      - 不学习3类、4类和5类的LSA
      - 学习1类、2类和7类LSA
      - 特殊区域的ABR路由器需要配置nssa no-summary
      - 该区域会通过ABR成产成一条默认的3类LSA和默认的7类LSA用于访问外部网络
      - 该区域的ABR会自动的将外部路由的7类的LSA转成5类的LSA
      - 7类的LSA只能在特殊区域NSSA内部传播，ABR设备将引入的外部路由——7类的LSA转成5类的LSA，在全网泛洪，让其他区域也学习到这条LSA，计算出来去往外部的路由
    - 备注：
      - totally nssa会产生两条默认的LSA，一个是3类默认，一个是7类默认
      - 当两条默认的LSA同时存在的时候，使用3类的默认，3类的默认优于7类的默认为什么？
        - 因为3类的默认LSA计算出来的路由是ospf的内部路由所以优先级为10
        - 因为7类的默认LSA计算出来的路由是ospf的外部路由所以优先级为150
      - 骨干区不能做成totally nssa区域
